name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies
      run: |
        poetry install --no-interaction --only main --no-root
        poetry run pip install pytest pytest-cov pytest-asyncio ruff mypy black

    - name: Create test environment file
      run: |
        cp .env.example .env 2>/dev/null || echo "No .env.example found, skipping"

    - name: Setup test data directories
      run: |
        mkdir -p data/processed data/raw logs models
        echo "Test data directories created"

    - name: Run unit tests with coverage
      run: poetry run pytest tests/ -v --tb=short --cov=api.app --cov=api.batch_predictions --cov=api.drift_api --cov=backend.auth --cov=backend.database --cov=backend.models --cov-report=term --cov-report=xml --cov-fail-under=75
      continue-on-error: false

    - name: Lint (ruff)
      run: |
        poetry run ruff check .
      continue-on-error: true

    - name: Type Check (mypy)
      run: |
        poetry run mypy --config-file pyproject.toml
      continue-on-error: true

    - name: Format Check (black)
      run: |
        poetry run black --check .
      continue-on-error: true

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Build
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}:latest

  deploy:
    name: Deploy Notification
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Deployment complete
      run: |
        echo "Docker image built and pushed successfully"
        echo "Ready for deployment"
